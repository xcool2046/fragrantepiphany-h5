# 后台方案（当前阶段）

## 范围与原则
- 聚焦内容运营：卡牌信息、解读库 CRUD 与导入导出、问卷配置。
- 支付相关后台功能（订单列表、价格配置）暂不提供，对外隐藏，后续客户加价再开。
- 配置由后端环境变量/常量控制，不允许通过后台修改价格或订单。
- 保持支付链路可用（前台解锁依赖订单状态），但仅用于业务，不提供管理界面。

## 模块与路由（计划保留）
- 登录/鉴权：单租户账号密码登录（已实现）。
### 4. 卡牌管理 (Cards)
- **路径**: `/admin/cards`
- **功能**:
    - **列表**: 查看所有卡牌，支持按 Code/Name 搜索。
    - **新增/编辑**:
        - **Code** (必填): 唯一标识 (e.g., `fool`, `magician`).
        - **Name EN** (必填): 英文名称.
        - **Image**: 支持上传本地图片或填写 URL。
    - **CSV 导入**:
        - 支持批量导入卡牌。
        - **格式**: `code,name_en,image_url` (表头)。
        - **Google Drive 支持**: `image_url` 可以填 Google Drive 分享链接（需开启“任何人可见”权限），系统会自动下载图片并存入服务器。
    - **导出**: 导出当前所有卡牌为 CSV。
- 解读库管理：
  - 按 `card_name + category(爱情/友情/亲情) + position(Past/Now/Future) + language` 的唯一组合增删改查。
  - 字段：sentence (原 summary)、interpretation、recommendation（列表）。
  - *注：action 和 future 字段已弃用。*
  - 批量导入导出：支持 CSV/JSON；导入前校验必填字段和重复组合。
- 问卷配置：
  - 三问四选一的文案与选项可编辑；支持多语言字段。
  - 状态保存后即时生效，前台读取最新配置。
- 香水管理 (Perfume Management)（已实现）：
  - 列表、查看、编辑香水信息（品牌、名称、香调、描述、文案 (Sentence)、图片）。
  - 支持中英双语字段编辑。
  - 关联卡牌与场景选择。
- 素材/静态配置（可选）：卡背/封面上传入口留空或简单上传，如时间不足可隐藏。

## 暂停/隐藏的功能
- 订单查看：后台不显示订单列表、详情、交易号等；相关路由与菜单隐藏或不注册。
- 价格配置：后台不提供价格编辑；使用 Stripe price_id 固定金额。

## 配置策略
- 环境变量：
  - `STRIPE_PRICE_IDS_JSON`（测试/正式各一组）仅后端持有，格式如 `{"usd":"price_x", "cny":"price_y"}`。
  - 其他基础开关（语言开关、回调地址等）可保留在配置接口，但不含价格。
- feature flag（建议）：
  - `FEATURE_ADMIN_ORDERS=false`
  - `FEATURE_ADMIN_PRICING=false`
  - 前后端共同使用，关闭时不渲染菜单/不注册路由。

## 前后端调整要点
- 后端：
  - Admin 配置 DTO 移除价格字段；条件化注册订单、价格相关 controller/route（开关关掉时不暴露）。
  - 保留 `order` 表和支付 webhook，用于前台支付状态，但不提供管理查询接口。
  - 在 `/api/admin/config` 返回当前 price_id（只读）及币种金额（可从 Stripe 拉取并缓存），供前台展示价格，不提供更新接口。
- 前端后台：
  - 移除/隐藏菜单项与页面：订单列表、价格设置。
  - 路由守卫：开关为 false 时跳转到默认页，避免空白页面。
- 前台用户侧：
  - 价格展示从后端接口获取只读的 price 信息或常量，不依赖后台配置。

## 交付与里程碑
- M1：隐藏订单与价格相关菜单/路由，清理配置字段，保证后台主导航仅保留卡牌、解读、问卷（+可选素材）。
- M2：补充导入导出校验、错误提示；前台确认读取最新问卷/解读配置。
- M3：如客户追加预算，再开启订单列表与价格配置：
  - 后端打开 feature flag，恢复接口；
  - 前端恢复菜单与页面；
  - 提供数据权限/审计（可选）。

## 风险与提醒
- 支付链路仍依赖订单表与 webhook，隐藏管理界面不会影响用户付费流程；测试需照常验证回调与解锁。
- 价格调整需在 Stripe 后台创建新价格并更新环境变量/配置中的 price_id；后台无编辑入口。
- 导入导出需校验组合唯一性，避免覆盖或重复记录。
