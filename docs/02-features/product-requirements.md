# 需求与范围（更新版）

## 背景与目标
- 塔罗抽牌占卜 H5 优先，兼顾 Web 优化。
- 跑通闭环：引导 → 问题选择 → 玩法介绍 → 抽牌动画 → 免费解析 → 付费 → 完整解析/推荐。
- 后台：后续可扩展，当前以前台闭环为主（后台英语即可，文案参考 `assets/Demo_11.18.pptx`）。

## 功能范围
- 页面流程：引导页、问题选择（禁止自定义输入，仅列表）、玩法介绍、抽牌动画页、免费解析、Stripe 收银台、支付回跳后的完整解析页（含推荐）。
- 抽牌规则：
  - 固定抽 3 张，位置 Past / Now / Future（默认不允许重复牌）。
  - 领域分类：爱情/友情/亲情（升级版 3 主题），问题分类可展示但不直接倍增解读分支。
- 问卷（来自 Demo_11.18.pptx）：
  - 三条必答问题，四选一：当前困扰领域（情感/事业/机遇/自我）、渴望获得（清晰/勇气/疗愈/验证）、当前状态（主动/观望/耗竭/理性）。
  - 选项应高亮显示，回答完才能继续。
- 动画期望：
  - 无需音效/震动；抽牌支持放大确认，再放入槽位；可用波纹/渐变/轻粒子转场，优先保证 H5 性能。
- 免费 vs 付费：
  - 免费：可展示“过去”部分（Past）概要。
  - 付费：解锁“现在状态 + 行动建议 + 未来预见”以及推荐等完整解读。
  - 价格：国内 RMB 15，国外 USD 5（单档，不区分套餐）。
- 多语言：
  - 前台默认英文，右上角可切换中文；使用 react-i18next，UI 文案内置 en/zh，不依赖外部文案表。
  - 后台仅英文。
- 支付与通知：
  - Stripe 收银台（测试 Key 先行），邮件通知模板可用默认占位，后续按文案调整。
  - 环境变量（请在部署时配置，不要提交到仓库）：
    - STRIPE_PUBLISHABLE_KEY (live)
    - STRIPE_SECRET_KEY (live)
    - STRIPE_PUBLISHABLE_KEY_TEST (test)
    - STRIPE_SECRET_KEY_TEST (test)
  - 价目（live）：
    - 产品：`prod_TRedSX1695NiSv`
    - 价格：RMB 15 → `price_1SUlJp2a1TSt8d5Us1Fvxyj3`（cny 1500）；USD 5 → `price_1SUlJq2a1TSt8d5UDjk1u0Ek`（usd 500）。
  - 正式 webhook signing secret：部署时通过环境变量配置（STRIPE_WEBHOOK_SECRET）。
- 管理与数据：
  - 卡牌/问题/解析/推荐规则 CRUD 预留接口或简易后台。
  - 数据量：78 张 * 3 主题 * 3 位置 * ~200 字 ≈ 14 万字；查询按 (card_name, category, position) 组合。
- 体验提示（来自 Demo_11.18.pptx）：
  - 抽牌动线：右侧卡牌轮盘，左侧 3 个槽位，占位提示不重复抽；点击放大确认后放入槽位，第三张后自动跳转 Loading。
  - 不需一次展示 78 张牌面，支持滚轮/滑动选择。
- 部署与配置：
  - 使用 Docker；域名与证书已准备。
  - 当前信息：服务器 IP 47.243.157.75（可免密 SSH root 登录）；前端域名 fragrantepiphany.com；后台域名 backend.fragrantepiphany.com（或 backend 子域）。
  - 后台账号：monicacjx / kittycjx88358985（可改价）。
  - Stripe 密钥已提供（pk_live/sk_live + pk_test/sk_test）；待补正式 webhook signing secret，建议前端测试用 pk_test，正式用 pk_live。
- 文案与数据交付：
  - 14 万字解读库尚未完备（参考 `assets/result.xlsx`），待客户补全；首版可先用占位/样例跑通接口。
## 默认交互与内容规则（便于直接开发）
- 抽牌页（半圆轮盘）：
  - 右侧半圆/210–240° 轮盘，卡背沿弧线均匀排列；左侧 Past/Now/Future 槽位。
  - 手势放大、滑动旋转、点击选中；选中放大 + “放入槽位”，飞入 200–250ms，放大 180–220ms。
  - 同屏 9–12 张，78 张可分批（分页/滑动）；已选隐藏，重选可恢复。
  - 第三张后自动跳转，前置 0.6–0.8s 轻量 Loading（渐变/波纹，禁重粒子/音效/震动）。
  - 提示文案：顶部“手指可放大牌轮，滑动牌轮，点击选牌”，底部“固定 3 张，不重复，第三张后自动跳转结果”。
- 问卷与结果关联：问卷仅收集意图，不改文案；结果页显示意图标签（如 关系与情感 / 渴望清晰 / 徘徊观望）。
- 结果页字段：Past（摘要 1–2 句 + 1 提示，免费）、Now（2–3 句）、Action（列表 2–3 条）、Future（2–3 句）、推荐（2–3 条卡片建议，可含再次占卜 CTA）；支付区显示 RMB 15 / USD 5 状态，失败/取消给“重试支付/返回首页”。
- 支付与回跳：成功提示解锁并刷新；失败/取消提示“支付未完成”+ 重试；回跳示例 `/pay/callback?status=success|fail`，前端读 query、后端 webhook 校验。
- 设计默认值（暖杏）：背景 #F7F0E5，卡片 #F3E6D7/#FFF，强调 #D4A373，辅色 #C49BA3，文字 #2B1F16，次文字 #6B5542；圆角卡片 18–22px，按钮 14–18px；阴影 `0 12px 30px rgba(0,0,0,0.08)`；按钮实底暖杏，hover 亮度+8–10%；语言切换按钮“EN / CN”浅描边半透明底；轻量波纹/渐变动效保持 60fps。
- 数据结构（占位）：`card_name, category(爱情/友情/亲情), position(Past/Now/Future), language(en/zh), summary, interpretation, recommendation[]`；可用 `sample-data/cards-example.json` 填充；问卷固定三问四选一，不影响解读，只展示标签。

## 抽牌界面（半圆轮盘方案，参考截图）
- 布局：右侧为半圆/210–240° 轮盘，卡背沿弧线均匀排列；左侧保留 Past/Now/Future 3 个槽位。
- 操作：支持手势放大轮盘、滑动旋转、点击选中；选中后卡背放大并显示“放入槽位”，确认后沿弧线/直线飞入槽位（200–250ms）。
- 数量：轮盘同时展示 9–12 张，78 张可分批（分页/滑动切换），已选牌从轮盘隐藏；重选可恢复。
- 节奏：放大 180–220ms，飞入 200–250ms，第三张后 0.6–0.8s 轻量 Loading/转场（渐变/波纹，禁重度粒子/音效/震动）。
- 提示：页面顶部文案 “手指可放大牌轮，滑动牌轮，点击选牌”；底部提示“固定 3 张，不重复，第三张后自动跳转结果”。

## 管理后台范围（按当前预算的轻量版）
- 登录/鉴权：简单账号密码（单租户），无多角色/权限。
- 价格配置：RMB / USD 单档价格可在后台调整（表单校验范围）；前端与创建支付时读取配置，避免硬编码。
- 卡牌信息：78 张卡牌的基本信息（名称、花色/编号、语言标签）查看/编辑。
- 解读库管理：按 `card_name + category(爱情/友情/亲情) + position(Past/Now/Future) + language` 编辑文案（摘要、现状、行动、未来、推荐）；提供批量导入/导出（CSV/JSON）作为主要数据入口，后台 CRUD 用于小批修正。
- 问卷配置：三问四选一的文案/选项可编辑；默认不影响解读逻辑，仅展示意图标签。
- 支付/订单查看：订单列表（成功/失败）、交易号，只读，不含退款界面；退款在 Stripe 端处理。
- 基础配置：支付回调地址、语言开关（EN/CN）、价格等基础开关。
- 可选（若有余力）：素材上传（卡背/Hero 图）、推荐文案列表、Stripe 回调日志查看（简单表格）。
- 不含/暂缓：多角色/权限、富文本、多版本文案管理、复杂报表/漏斗、多套餐/多币种、丰富推荐算法配置。

## 非目标/暂缓
- 用户自定义问题输入（不支持）。
- 多档/套餐定价（暂不做）。
- 结果邮件模板可后置；高级推荐算法暂不做。

## 验收标准（前台闭环为主）
- 抽牌→免费解析→付费→完整解析/推荐 全流程可用；付费后状态与展示一致。
- Stripe 支付回跳成功/失败状态可见。
- 抽牌规则与领域分类按上述约束运行；不允许重复牌。
- 多语言切换有效（英/中）。
- 性能：卡牌解读查询基于复合索引/缓存，响应可控；移动端触控与动画体验顺畅。

## 依赖与前置
- Stripe 测试/正式 Key，支付域名/回调域名。
- 文案与数据：14 万字解读库（中/英可后续补充），问题列表与分类，About/提示语。
- 素材：牌面、背景、图标、抽牌动画参考；品牌主/辅色、Logo。
- 域名与服务器：由我代部署，待客户提供域名与机器后对接。

## 素材使用规范
- 卡面/牌背：优先使用本地 `assets/cards/`，按文件名映射到 card_name；如需规范可用 `<suit>_<number或major>.jpg/png`（例：`wands_ace.jpg`、`cups_2.jpg`、`major_00_fool.jpg`），未规范的可通过配置表映射。
- 网页/背景：使用 `assets/web/` 或可商用免费图库（Unsplash/Pexels 等），记录来源，后续可替换。
- 字体/图标：优先开源或已授权资源，避免未授权商用素材。
- 图片优化：优先 WebP/JPEG，控制体积；保持目录结构（cards/web），命名清晰。

## 实施进度

### Phase 1: 核心流程 (Completed)
- [x] 抽牌 UI (半圆轮盘)
- [x] 结果页 (免费/付费逻辑)
- [x] 支付流程 (Stripe CNY/USD)
- [x] 香水推荐旅程 (Perfume Journey)

### Phase 2: 管理后台 (Completed)
- [x] 登录/鉴权
- [x] 解读库管理 (CRUD + Import/Export)
- [x] 订单查看
- [x] 价格配置

### Phase 3: UI 调整与新功能 (Pending)
- [ ] 待定 UI 调整
- [ ] 待定新功能

### 已知问题与待优化 (Known Issues)
- **支付回调持久化**: 需验证支付成功后刷新页面的状态保持（依赖后端订单查询接口）。
- **H5 交互**: Draw 页面轮盘在部分机型可能交互困难，已增加兜底按钮；Quiz 页面需保证底部按钮不被遮挡（Sticky Footer）。
- **分享功能**: 需完善非原生分享环境下的降级处理（Clipboard）。
