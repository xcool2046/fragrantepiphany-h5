# 选中翻牌与问卷逻辑方案

## 需求理解
1. **选中后翻转**: 用户点击卡牌后,卡牌执行翻转动画
2. **显示正面**: 翻转后显示塔罗牌的正面图案
3. **素材路径**: 使用 `/home/code/h5-web/assets/cards` 下的78张塔罗牌图片
4. **智能选择**: 根据问卷答案，智能推荐对应的塔罗牌

---

## 一、当前技术栈分析

### 1. 卡牌图片资源
*   **位置**: `/home/code/h5-web/assets/cards`
*   **文件命名**: `IMG_4773.JPG` 至 `IMG_4850.JPG` (共78张)
*   **数据映射**: `tarot_data.json` 将每张牌的ID映射到对应的图片文件名

### 2. 问卷流程
*   **文件**: `Quiz.tsx`
*   **数据传递**: 完成问卷后，通过 `navigate('/draw', { state: { answers: finalAnswers } })` 传递答案
*   **答案结构**: `{ q1: string, q2: string, q3: string }`

### 3. 当前Draw页面
*   **卡牌总数**: 硬编码 78 张
*   **卡牌数据**: 从 `tarot_data.json` 读取
*   **选中逻辑**: 点击后添加到 `selected` 数组，达到 3 张后跳转到 `/result`

---

## 二、实现方案

### 方案A: 基于问卷答案的智能推荐 (推荐)

#### 2.1 逻辑设计
1. **答案到关键词映射**
   - 每个答案对应一组情感关键词 (如: "独立", "成长", "家庭")
   - 问卷3道题 → 汇总得出3-5个核心关键词

2. **关键词到牌组映射**
   - 每张塔罗牌预设标签/关键词 (已在 `tarot_data.json` 中有 `meaning` 字段)
   - 根据关键词匹配度，筛选出20-30张候选牌

3. **轮盘展示**
   - 将候选牌池随机排列在右侧轮盘上
   - 用户滑动并选择3张

#### 2.2 翻牌动画
*   **触发时机**: 点击卡牌 → 确认选中
*   **动画效果**:
    *   3D Y轴翻转 180° (使用 `rotateY`)
    *   持续时间 0.6-0.8秒
    *   缓动函数 `ease-out`
*   **正/反面切换**:
    *   反面: 当前的深褐色卡牌背景 + 金色纹饰
    *   正面: 显示对应的 `IMG_XXXX.JPG` 图片

#### 2.3 数据流
```
Quiz答案 → 关键词提取 → 候选牌池筛选 → Draw页面接收 → 渲染候选牌轮盘 → 用户选择 → 翻牌动画 → Result页面
```

---

### 方案B: 简化版 - 固定牌池 (备选)

如果问卷逻辑复杂度过高,可采用简化方案:
1. **固定78张牌全部展示** (当前已实现)
2. **用户自由选择** 任意3张
3. **翻牌后显示正面**
4. **Result页面** 根据选中的牌ID + 问卷答案,生成个性化解读

---

## 三、技术要点

### 3.1 图片路径处理
*   **源路径**: `/home/code/h5-web/assets/cards/IMG_4773.JPG`
*   **目标路径**: 需复制到 `/home/code/h5-web/frontend/public/assets/cards/`
*   **引用方式**: `/assets/cards/IMG_4773.JPG`

### 3.2 翻牌动画实现
*   **使用 Framer Motion**:
    *   `animate` 属性控制旋转角度
    *   `variants` 定义正/反面状态
*   **双层结构**:
    *   外层容器: 控制翻转动画
    *   内层前后面板: 绝对定位,`backface-visibility: hidden`

### 3.3 候选牌筛选算法
1. **权重计算**:
   - 遍历78张牌,计算每张牌与用户关键词的匹配分数
   - 分数 = (关键词出现频率 × 权重系数)
2. **排序与截取**:
   - 按分数从高到低排序
   - 取前25-30张作为候选池
   - 打乱顺序后展示在轮盘上

---

## 四、实施优先级

### P0 (核心功能)
1. 复制卡牌图片到 `frontend/public/assets/cards`
2. 修改 `Draw.tsx`,为选中卡牌添加翻转动画
3. 翻转后显示对应的正面图片

### P1 (智能推荐)
4. 设计答案 → 关键词映射表
5. 实现候选牌筛选逻辑
6. 修改 `Draw.tsx`,仅渲染候选牌池

### P2 (优化体验)
7. 选中3张后的飞入槽位动画
8. 卡牌翻转时的光效/粒子特效

---

## 五、注意事项
1. **性能**: 78张牌的图片总大小约30-40MB,需确保加载性能
2. **候选牌数量**: 建议20-30张,太少限制用户选择,太多失去智能推荐意义
3. **答案隐私**: 问卷答案仅用于前端筛选,不上传到服务器 (已验证,当前使用 `navigate state`)
4. **兼容性**: 翻转动画需测试iOS Safari的3D变换支持

---

## 六、示例流程

**用户旅程**:
1. 完成Quiz问卷 (选择: q1="成长", q2="独立", q3="家庭")
2. 进入Draw页面
3. 系统展示25张与"成长/独立/家庭"相关的候选牌
4. 用户滑动轮盘,点击第一张牌
5. 卡牌翻转,显示 "The Fool" (愚者) 正面
6. 重复选择至3张
7. 所有牌完成翻转后,飞入屏幕下方槽位
8. 跳转Result页面,根据选中牌+问卷答案生成解读
